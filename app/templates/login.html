{% extends "layout2.html" %} {% include 'navbar2.html' %} {% block content %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/layout2.css') }}"
/>
  <div class="container mt-3 d-flex">
    <div
      id="toast"
      class="toast fade align-items-center text-white bg-success border-0 position-fixed top-5 start-50 translate-middle"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
      style="z-index: 2000;"
    >
    
      <div class="d-flex">
        <!-- Aquí entra el mensaje -->
        <div class="toast-body" id="toast-message"></div>
        <!-- Botón de cerrar -->
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          onclick="hideToast()"
        ></button>
      </div>
    </div>
  </div>

<section id="Login" class="section">
  <div class="container py-5 d-flex">
    <div class="row d-flex justify-content-center" style="width: 100%">
      <!-- Título -->
      <h2 class="navbar-title text-center mb-4" lan-target="TituloLogin">Inicia Sesión</h2>


      <div class="col-md-12 d-flex justify-content-center">
        <div class="login-form">
          <!-- Formulario -->
          <form id="loginForm" method="POST" action="/auth/login">
            <!-- Imagen superior -->
            <img
              src="{{ url_for('static', filename='img/login.png') }}"
              alt="Login"
              class="img-form d-block mx-auto mb-3"
            />

            <!-- Username -->
            <div class="mb-3">
              <label class="text"><strong lan-target="LabelUsuario">Usuario</strong></label>
              <input
                type="text"
                name="username"
                class="form-control"
                lan-placeholder="PlaceholderUsuario"
                placeholder="Nombre de usuario"
                required
                required
              />
            </div>

            <!-- Contraseña -->
            <div class="mb-3">
              <label class="text"><strong lan-target="LabelContraseña">Contraseña</strong></label>
              <input
                type="password"
                name="password"
                class="form-control"
                lan-placeholder="PlaceholderContraseña"
                placeholder="Contraseña"
                required
                required
              />
            </div>

            <!-- Botón -->
            <button type="submit" class="btn btn-primary d-block mx-auto">
              <i class="fas fa-sign-in-alt me-1"></i> <span lan-target="BotonIngresar">Ingresar</span>
            </button>

            <!-- Enlace de recuperación -->
            <div class="text-center my-3">
              <a href="#" data-bs-toggle="modal" data-bs-target="#modalRecuperarContraseña" lan-target="OlvideContraseña">Olvidé mi contraseña</a>
            </div>

            <div class="text-center">
               <p>
                <span lan-target="NoCuenta">¿No tiene una cuenta?</span>
                <a href="#" data-bs-toggle="modal" data-bs-target="#modalPoliticas" lan-target="RegistrarseAqui">Regístrese aquí</a>
              </p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="modalPoliticas" tabindex="-1" aria-labelledby="modalPoliticasLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header text-white">
        <h5 class="modal-title" id="modalPoliticasLabel" lan-target="Política de Tratamiento de datos">Política de Tratamiento de datos</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <h3 lan-target="Estimado Usuario">Estimado Usuario</h3>
        <p lan-target="IntroPolitica">
          En cumplimiento de la normativa vigente sobre protección de datos personales, le informamos que sus datos serán tratados de acuerdo con nuestra Política de Tratamiento de Datos Personales redactada a continuación:
        </p>

          <h5 lan-target="Responsable del tratamiento">1. Reponsable del tratamiento:</h5>
          <p lan-target="TextoResponsable">
            Vitaria SOS es responsable del tratamiento de los datos personales suministrados por los usuarios, conforme a lo dispuesto en la Ley 1581 de 2012 y demás normas que la modifiquen o complementen.
          </p>
          <h5 lan-target="Finalidades del Tratamiento">2. Finalidades del Tratamiento:</h5>
          <ul>
          <li><span lan-target="Finalidad1">Gestionar el registro, autenticación y acceso de usuarios a la plataforma.</span></li>
          <li><span lan-target="Finalidad2">Administrar y mantener actualizada la información de los usuarios.</span></li>
          <li><span lan-target="Finalidad3">Procesar solicitudes, reportes o casos relacionados con el uso del sistema.</span></li>
          <li><span lan-target="Finalidad4">Enviar información relevante sobre actualizaciones, cambios o avisos del servicio.</span></li>
          <li><span lan-target="Finalidad5">Realizar análisis estadísticos y de mejora continua del sistema.</span></li>
        </ul>

        <h5 lan-target="Derechos del Titular">3. Derechos del Titular:</h5>
        <p>De acuerdo con la ley, el titular de los datos personales tiene derecho a:</p>
        <ul>
          <li><span lan-target="Derecho1">Conocer, actualizar y rectificar sus datos.</span></li>
          <li><span lan-target="Derecho2">Ser informado sobre el uso que se da a sus datos.</span></li>
          <li><span lan-target="Derecho3">Revocar la autorización y/o solicitar la supresión de sus datos cuando no se respeten los principios, derechos y garantías constitucionales y legales.</span></li>
        </ul>

        <h5 lan-target="Autorización">4. Autorización:</h5>
        <p lan-target="TextoAutorizacion">
          Al aceptar esta Política, usted autoriza de manera libre, previa, expresa e informada el tratamiento de sus datos personales conforme a las finalidades descritas. El responsable garantiza que sus datos serán tratados de forma segura, confidencial y únicamente para los fines autorizados.
        </p>

        <h5 lan-target="Vigencia">5. Vigencia:</h5>
        <p lan-target="TextoVigencia">
          Esta Política entra en vigencia a partir de su publicación y permanecerá vigente mientras se mantenga la relación con el usuario o mientras sea necesario para el cumplimiento de las finalidades descritas.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" lan-target="Cancelar">Cancelar</button>
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary" lan-target="Aceptar">Aceptar</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalRecuperarContraseña" tabindex="-1" aria-labelledby="modalRecuperarContraseñaLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <<h5 class="modal-title" id="modalRecuperarContraseñaLabel" lan-target="TituloRecuperarContraseña">Recuperar Contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>
              <div class="modal-body">
                <form id="recuperarContraseñaForm" method="POST" action="{{ url_for('auth.forget_password') }}">
                  <div class="mb-3">
                      <label for="username" class="form-label" lan-target="LabelNombreUsuario">Nombre de usuario</label>
                      <input type="text" class="form-control" placeholder="Ingrese el nombre de usuario con el que se registró" id="username" name="username" required>
                    </div>
                  <div class="mb-3">
                     <label for="email" class="form-label" lan-target="LabelCorreoElectronico">Correo electrónico</label>
                    <input type="email" class="form-control" placeholder="Ingrese el correo electrónico que ingresó al registrarse" id="email" name="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" lan-target="BotonRecuperarContraseña">Recuperar contraseña</button>
                </form>
              </div>
            </div>
          </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/traductor2.js') }}"></script>
<script src="{{ url_for('static', filename='js/traductor_toast.js') }}"></script>
<script src="{{ url_for('static', filename='js/alert.js') }}"></script>
<script>
// Manejo específico para cada formulario
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  await handleFormSubmit(e, 'login');
});

document.getElementById('recuperarContraseñaForm').addEventListener('submit', async (e) => {
  await handleFormSubmit(e, 'recovery');
});

// Función principal para manejar envíos
async function handleFormSubmit(e, formType) {
  e.preventDefault();
  const form = e.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;

  try {
    // Configurar estados de loading según el tipo de formulario
    if (formType === 'login') {
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ' + t("BtnValidandoCredenciales");
    } else {
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ' + t("BtnEnviando");
    }
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const response = await fetch(form.action, {
      method: "POST",
      body: formData,
    });

    const result = await response.json();
    console.log(`Respuesta ${formType}:`, result);

    // Mostrar toast siempre
    showToast(result.msg, result.status);

    // Manejar redirecciones y acciones según el tipo de formulario
    if (result.status === "success") {
      if (formType === 'login') {
        sessionStorage.setItem("toastMessage", result.msg);
        sessionStorage.setItem("toastType", result.status);
        
        setTimeout(() => {
          if (result.redirect) {
            window.location.href = result.redirect;
          } else {
            // Redirección por defecto según el rol
            window.location.href = "/user/dashboard";
          }
        }, 1000);
      } else if (formType === 'recovery') {
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalRecuperarContraseña'));
          if (modal) {
            modal.hide();
          }
        }, 1500);
        
        setTimeout(() => {
          window.location.href = "/auth/login";
        }, 2000);
      }
    } else {
      // Reactivar botón en caso de error
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }

  } catch (error) {
    console.error(`Error en ${formType}:`, error);
    const errorMsg = formType === 'login' 
      ? "Ocurrió un error al intentar iniciar sesión.❌" 
      : "Ocurrió un error al procesar la solicitud.❌";
    
    showToast(errorMsg, "error");
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const idioma = localStorage.getItem("vitaria_idioma") || "es";
  const t = window.t;

});
// Reset del formulario cuando se cierra el modal
document.getElementById('modalRecuperarContraseña').addEventListener('hidden.bs.modal', function () {
  const form = document.getElementById('recuperarContraseñaForm');
  if (form) {
    form.reset();
  }
});
</script>
{% endblock %}
